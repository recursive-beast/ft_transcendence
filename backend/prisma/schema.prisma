generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id                  Int                  @id @default(autoincrement())
    authProviderId      String               @unique
    displayName         String               @unique
    fullName            String
    avatar              String?
    otpSecret           String?
    otpIsEnabled        Boolean              @default(false)
    createdAt           DateTime             @default(now())
    updatedAt           DateTime             @updatedAt
    friends             User[]               @relation("friends")
    friendOf            User[]               @relation("friends")
    blocked             User[]               @relation("blocked")
    blockedBy           User[]               @relation("blocked")
    notifications       Notification[]
    messages            Message[]
    directConversations DirectConversation[]
    GroupMember         GroupMember[]
    bannedFromGroups    GroupConversation[]
}

model Notification {
    id          Int              @id @default(autoincrement())
    type        NotificationType
    seen        Boolean          @default(false)
    recipient   User             @relation(fields: [recepientId], references: [id])
    recepientId Int
    data        Json
    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt
}

enum NotificationType {
    FRIEND_ADD
}

model Message {
    id                   Int                 @id @default(autoincrement())
    sender               User                @relation(fields: [senderId], references: [id])
    senderId             Int
    text                 String
    createdAt            DateTime            @default(now())
    updatedAt            DateTime            @updatedAt
    seen                 Boolean             @default(false)
    directConversation   DirectConversation? @relation(fields: [directConversationId], references: [id])
    directConversationId Int?
    groupConversation    GroupConversation?  @relation(fields: [groupConversationId], references: [id])
    groupConversationId  Int?
}

model DirectConversation {
    id        Int       @id @default(autoincrement())
    messages  Message[]
    members   User[]
    isGroup   Boolean   @default(false)
    isDirect  Boolean   @default(true)
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
}

enum roleType {
    OWNER
    ADMIN
    MEMBER
}

model GroupMember {
    id                  Int               @id @default(autoincrement())
    user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId              Int
    role                roleType          @default(MEMBER)
    mutedUntil          DateTime?
    groupConversation   GroupConversation @relation(fields: [groupConversationId], references: [id], onDelete: Cascade)
    groupConversationId Int
    createdAt           DateTime          @default(now())
    updatedAt           DateTime          @updatedAt
    seenAt              DateTime          @default(now())
}

enum groupType {
    PUBLIC
    PROTECTED
    PRIVATE
}

model GroupConversation {
    id        Int           @id @default(autoincrement())
    title     String        @unique()
    avatar    String?
    type      groupType     @default(PUBLIC)
    password  String?
    banned    User[]
    members   GroupMember[]
    messages  Message[]
    isGroup   Boolean       @default(true)
    isDirect  Boolean       @default(false)
    createdAt DateTime      @default(now())
    updatedAt DateTime      @updatedAt
}
